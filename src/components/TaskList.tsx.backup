import { useState } from 'react'
import { PlusCircle, Download, CheckCircle, Clock, AlertCircle, FileText, Image, Paperclip, X, MoreVertical } from 'lucide-react'
import { Checkbox } from '@/components/ui/checkbox'
import { Avatar } from '@/components/ui/avatar'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { Progress } from '@/components/ui/progress'
import { cn } from '@/lib/utils'
import { useTasks } from '@/contexts/TaskContext'
import { useFiles } from '@/contexts/FileContext'
import { useTeam } from '@/contexts/TeamContext'
import { EditTaskDialog } from '@/components/EditTaskDialog'
import { DeleteConfirmDialog } from '@/components/DeleteConfirmDialog'
import { PriorityBadge } from '@/components/PriorityBadge'

export function TaskList() {
  const [activeTab, setActiveTab] = useState<'tasks' | 'files' | 'documents'>('tasks')
  const { tasks, toggleTaskStatus, toggleSubtask, toggleChecklistItem, deleteTask, deleteSubtask, deleteChecklistItem, removeFile, addSubtask, addChecklistItem } = useTasks()
  const { files } = useFiles()
  const { teamMembers } = useTeam()

  // State for inline forms
  const [addingSubtaskTo, setAddingSubtaskTo] = useState<string | null>(null)
  const [addingChecklistTo, setAddingChecklistTo] = useState<string | null>(null)
  const [newSubtaskLabel, setNewSubtaskLabel] = useState('')
  const [newChecklistLabel, setNewChecklistLabel] = useState('')
  const [subtaskAssignee, setSubtaskAssignee] = useState(teamMembers[0]?.id || '')

  const handleAddSubtask = (taskId: string) => {
    if (!newSubtaskLabel.trim()) return
    addSubtask(taskId, { label: newSubtaskLabel, assigneeId: subtaskAssignee })
    setNewSubtaskLabel('')
    setAddingSubtaskTo(null)
  }

  const handleAddChecklist = (taskId: string) => {
    if (!newChecklistLabel.trim()) return
    addChecklistItem(taskId, newChecklistLabel)
    setNewChecklistLabel('')
    setAddingChecklistTo(null)
  }

  return (
    <div className="bg-white dark:bg-slate-900/50 rounded-xl p-6 border border-slate-200 dark:border-slate-800">
      {/* Tabs */}
      <div className="flex border-b border-slate-200 dark:border-slate-800 mb-6">
        <button
          onClick={() => setActiveTab('tasks')}
          className={cn(
            'px-4 py-3 text-sm border-b-2',
            activeTab === 'tasks'
              ? 'border-primary text-primary font-semibold'
              : 'border-transparent text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 font-medium'
          )}
        >
          Current Tasks
        </button>
        <button
          onClick={() => setActiveTab('files')}
          className={cn(
            'px-4 py-3 text-sm border-b-2',
            activeTab === 'files'
              ? 'border-primary text-primary font-semibold'
              : 'border-transparent text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 font-medium'
          )}
        >
          Required Files
        </button>
        <button
          onClick={() => setActiveTab('documents')}
          className={cn(
            'px-4 py-3 text-sm border-b-2',
            activeTab === 'documents'
              ? 'border-primary text-primary font-semibold'
              : 'border-transparent text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 font-medium'
          )}
        >
          Stage Documents
        </button>
      </div>

      {/* Task List */}
      {activeTab === 'tasks' && (
        <div className="space-y-4">
          {tasks.map((task) => (
            <div
              key={task.id}
              className={cn(
                'p-4 rounded-lg',
                task.status === 'blocked'
                  ? 'bg-warning/10 dark:bg-warning/20 border border-warning/50'
                  : 'bg-slate-50 dark:bg-slate-800/50'
              )}
            >
              <div className="flex items-start gap-4">
                <Checkbox
                  checked={task.status === 'completed'}
                  onCheckedChange={() => toggleTaskStatus(task.id)}
                  className="mt-1"
                />
                <div className="flex-1">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="font-medium text-slate-800 dark:text-slate-200">
                        {task.title}
                      </p>
                      <p
                        className={cn(
                          'text-xs',
                          task.status === 'blocked'
                            ? 'text-warning font-semibold'
                            : 'text-slate-500 dark:text-slate-400'
                        )}
                      >
                        Due: {task.dueDate}
                      </p>
                    </div>
                    <div className="flex items-center gap-2">
                      <Avatar
                        src={task.assignee.avatar}
                        className="size-6 ring-2 ring-white dark:ring-slate-900"
                      />
                      <PriorityBadge priority={task.priority} />
                      {task.status === 'completed' && (
                        <Badge variant="success">Completed</Badge>
                      )}
                      {task.status === 'in-progress' && (
                        <Badge className="bg-primary/20 text-primary">In Progress</Badge>
                      )}
                      {task.status === 'todo' && (
                        <Badge className="bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300">
                          To Do
                        </Badge>
                      )}
                      {task.status === 'blocked' && (
                        <Badge variant="danger">Blocked</Badge>
                      )}
                      <div className="flex gap-1 ml-2">
                        <EditTaskDialog task={task} />
                        <DeleteConfirmDialog
                          onConfirm={() => deleteTask(task.id)}
                          title="Delete Task"
                          description={`Are you sure you want to delete "${task.title}"? This will also delete all subtasks, checklists, and attachments.`}
                        />
                      </div>
                    </div>
                  </div>

                  {/* Checklist for completed tasks */}
                  {task.checklistItems && task.checklistItems.length > 0 && (
                    <div className="mt-4 space-y-3 pl-4 border-l border-slate-200 dark:border-slate-700">
                      <div className="flex items-center justify-between">
                        <p className="text-xs font-medium text-slate-500 dark:text-slate-400">
                          Checklist ({task.checklistItems.filter((i) => i.completed).length}/
                          {task.checklistItems.length})
                        </p>
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => setAddingChecklistTo(task.id)}
                          className="h-auto p-0 text-xs text-primary hover:text-primary/80"
                        >
                          <PlusCircle className="h-3 w-3 mr-1" />
                          Add Item
                        </Button>
                      </div>
                      {task.checklistItems.map((item) => (
                        <div key={item.id} className="flex items-center gap-2 group">
                          <Checkbox
                            checked={item.completed}
                            onCheckedChange={() => toggleChecklistItem(task.id, item.id)}
                            className="h-4 w-4"
                          />
                          <label
                            className={cn(
                              'text-sm flex-1',
                              item.completed
                                ? 'text-slate-600 dark:text-slate-300 line-through'
                                : 'text-slate-800 dark:text-slate-200'
                            )}
                          >
                            {item.label}
                          </label>
                          <Button
                            variant="ghost"
                            size="icon"
                            onClick={() => deleteChecklistItem(task.id, item.id)}
                            className="h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity"
                          >
                            <X className="h-3 w-3 text-slate-500" />
                          </Button>
                        </div>
                      ))}
                      {addingChecklistTo === task.id && (
                        <div className="flex gap-2">
                          <input
                            type="text"
                            value={newChecklistLabel}
                            onChange={(e) => setNewChecklistLabel(e.target.value)}
                            onKeyDown={(e) => e.key === 'Enter' && handleAddChecklist(task.id)}
                            placeholder="New checklist item..."
                            className="flex h-8 w-full rounded-md border border-input bg-background px-2 text-sm"
                            autoFocus
                          />
                          <Button size="sm" onClick={() => handleAddChecklist(task.id)} className="h-8">
                            Add
                          </Button>
                          <Button
                            variant="ghost"
                            size="sm"
                            onClick={() => {
                              setAddingChecklistTo(null)
                              setNewChecklistLabel('')
                            }}
                            className="h-8"
                          >
                            Cancel
                          </Button>
                        </div>
                      )}
                    </div>
                  )}

                  {/* Subtasks */}
                  {(task.subtasks && task.subtasks.length > 0) || addingSubtaskTo === task.id ? (
                    <div className="mt-4">
                      {task.subtasks && task.subtasks.length > 0 && (
                        <>
                          <div className="mb-3">
                            <div className="flex items-center justify-between mb-1">
                              <p className="text-xs font-medium text-slate-500 dark:text-slate-400">
                                Subtasks ({task.subtasks.filter((s) => s.completed).length}/
                                {task.subtasks.length})
                              </p>
                              <Button
                                variant="ghost"
                                size="sm"
                                onClick={() => setAddingSubtaskTo(task.id)}
                                className="h-auto p-0 text-xs text-primary hover:text-primary/80"
                              >
                                <PlusCircle className="h-3 w-3 mr-1" />
                                Add Subtask
                              </Button>
                            </div>
                            <Progress
                              value={
                                (task.subtasks.filter((s) => s.completed).length /
                                  task.subtasks.length) *
                                100
                              }
                            />
                          </div>
                          <div className="space-y-2">
                            {task.subtasks.map((subtask) => (
                              <div
                                key={subtask.id}
                                className="flex items-center justify-between p-3 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 group"
                              >
                                <div className="flex items-center gap-3 flex-1">
                                  <Checkbox
                                    checked={subtask.completed}
                                    onCheckedChange={() => toggleSubtask(task.id, subtask.id)}
                                    className="h-4 w-4"
                                  />
                                  <p
                                    className={cn(
                                      'text-sm flex-1',
                                      subtask.completed
                                        ? 'text-slate-800 dark:text-slate-200 line-through'
                                        : 'text-slate-800 dark:text-slate-200'
                                    )}
                                  >
                                    {subtask.label}
                                  </p>
                                </div>
                                <div className="flex items-center gap-2">
                                  <Avatar src={subtask.avatar} className="size-5" />
                                  <Button
                                    variant="ghost"
                                    size="icon"
                                    onClick={() => deleteSubtask(task.id, subtask.id)}
                                    className="h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity"
                                  >
                                    <X className="h-3 w-3 text-danger" />
                                  </Button>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                      {addingSubtaskTo === task.id && (
                        <div className="p-3 rounded-lg bg-slate-50 dark:bg-slate-800/50 border border-dashed border-slate-300 dark:border-slate-600">
                          <div className="space-y-2">
                          <input
                            type="text"
                            value={newSubtaskLabel}
                            onChange={(e) => setNewSubtaskLabel(e.target.value)}
                            onKeyDown={(e) => e.key === 'Enter' && handleAddSubtask(task.id)}
                            placeholder="Subtask description..."
                            className="flex h-9 w-full rounded-md border border-input bg-background px-3 text-sm"
                            autoFocus
                          />
                          <div className="flex gap-2">
                            <select
                              value={subtaskAssignee}
                              onChange={(e) => setSubtaskAssignee(e.target.value)}
                              className="flex h-8 flex-1 rounded-md border border-input bg-background px-2 text-xs"
                            >
                              {teamMembers.map((member) => (
                                <option key={member.id} value={member.id}>
                                  {member.name}
                                </option>
                              ))}
                            </select>
                            <Button size="sm" onClick={() => handleAddSubtask(task.id)} className="h-8">
                              Add
                            </Button>
                            <Button
                              variant="ghost"
                              size="sm"
                              onClick={() => {
                                setAddingSubtaskTo(null)
                                setNewSubtaskLabel('')
                              }}
                              className="h-8"
                            >
                              Cancel
                            </Button>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                ) : (
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={() => setAddingSubtaskTo(task.id)}
                    className="mt-3 text-xs text-primary hover:text-primary/80"
                  >
                    <PlusCircle className="h-3 w-3 mr-1" />
                    Add Subtask
                  </Button>
                )}

                  {/* File Attachments */}
                  {task.attachments && task.attachments.length > 0 && (
                    <div className="mt-4 space-y-3">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2 text-sm font-medium text-slate-600 dark:text-slate-300">
                          <Paperclip className="h-4 w-4" />
                          <span>{task.attachments.length} Attachment{task.attachments.length !== 1 ? 's' : ''}</span>
                        </div>
                      </div>
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        {task.attachments.map((file) => (
                          <div
                            key={file.id}
                            className="flex items-center gap-2 p-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 group hover:border-primary/50 transition-colors"
                          >
                            <div className="flex items-center justify-center size-9 bg-primary/10 text-primary rounded-md shrink-0">
                              {file.type === 'pdf' && <FileText className="h-4 w-4" />}
                              {file.type === 'image' && <Image className="h-4 w-4" />}
                              {file.type === 'doc' && <FileText className="h-4 w-4" />}
                            </div>
                            <div className="flex-1 min-w-0">
                              <p className="text-xs font-medium text-slate-800 dark:text-slate-200 truncate">
                                {file.name}
                              </p>
                              <p className="text-xs text-slate-500 dark:text-slate-400">
                                {file.size}
                              </p>
                            </div>
                            <div className="flex gap-1">
                              <Button
                                variant="ghost"
                                size="icon"
                                className="h-7 w-7 hover:bg-primary/10 hover:text-primary"
                                title="Download"
                              >
                                <Download className="h-3 w-3" />
                              </Button>
                              <Button
                                variant="ghost"
                                size="icon"
                                onClick={() => removeFile(task.id, file.id)}
                                className="h-7 w-7 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-danger/10 hover:text-danger"
                                title="Delete"
                              >
                                <X className="h-3 w-3" />
                              </Button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Required Files Table */}
      {activeTab === 'files' && (
        <div>
          {/* Table Header */}
          <div className="grid grid-cols-[1fr_auto_auto_auto] gap-x-6 items-center py-2 px-4 text-xs font-semibold text-slate-500 dark:text-slate-400 border-b border-slate-200 dark:border-slate-800 uppercase">
            <span>File Name</span>
            <span className="text-center">Required From</span>
            <span className="text-center">Status</span>
            <span className="text-right">Actions</span>
          </div>
          {/* Table Rows */}
          <div className="divide-y divide-slate-200 dark:divide-slate-800">
            {files.map((file) => (
              <div
                key={file.id}
                className="grid grid-cols-[1fr_auto_auto_auto] gap-x-6 items-center py-4 px-4 hover:bg-slate-50 dark:hover:bg-slate-800/50"
              >
                {/* File Name */}
                <div>
                  <p className="font-medium text-slate-800 dark:text-slate-200">
                    {file.fileName}
                  </p>
                  <p className="text-xs text-slate-500 dark:text-slate-400">
                    {file.uploadDate ? `Uploaded: ${file.uploadDate}` : 'Not yet uploaded'}
                  </p>
                </div>
                {/* Required From */}
                <div className="text-center text-sm">{file.requiredFrom}</div>
                {/* Status */}
                <div className="flex justify-center">
                  {file.status === 'received' && (
                    <Badge
                      variant="success"
                      className="flex items-center gap-1.5"
                    >
                      <CheckCircle className="h-3 w-3" />
                      <span>Received</span>
                    </Badge>
                  )}
                  {file.status === 'pending' && (
                    <Badge
                      variant="warning"
                      className="flex items-center gap-1.5"
                    >
                      <Clock className="h-3 w-3" />
                      <span>Pending</span>
                    </Badge>
                  )}
                  {file.status === 'missing' && (
                    <Badge
                      className="flex items-center gap-1.5 bg-danger/20 text-danger"
                    >
                      <AlertCircle className="h-3 w-3" />
                      <span>Missing</span>
                    </Badge>
                  )}
                </div>
                {/* Actions */}
                <div className="flex justify-end items-center gap-2">
                  {file.status === 'received' ? (
                    <Button
                      variant="ghost"
                      size="icon"
                      className="h-8 w-8 hover:bg-slate-200 dark:hover:bg-slate-700"
                    >
                      <Download className="h-5 w-5" />
                    </Button>
                  ) : (
                    <>
                      <Button
                        variant="ghost"
                        size="sm"
                        className="h-8 px-3 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600"
                      >
                        Upload
                      </Button>
                      {file.status === 'missing' && (
                        <Button
                          variant="ghost"
                          size="icon"
                          className="h-8 w-8 hover:bg-slate-200 dark:hover:bg-slate-700"
                        >
                          <MoreVertical className="h-5 w-5" />
                        </Button>
                      )}
                    </>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Stage Documents */}
      {activeTab === 'documents' && (
        <div className="text-center py-12 text-slate-500 dark:text-slate-400">
          Stage documents content coming soon...
        </div>
      )}
    </div>
  )
}
